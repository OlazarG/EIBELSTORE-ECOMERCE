<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin</title>
    <link rel="stylesheet" href="../../../css/base.css">
    <link rel="stylesheet" href="../../../css/background.css">
    <link rel="stylesheet" href="../../../css/website.css">
    <style>
        /* Dashboard specific overrides */
        body {
            display: block;
            height: auto;
            overflow: auto;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Redesign */
        .sidebar {
            width: 260px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color);
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .sidebar-brand {
            font-family: var(--font-main);
            color: var(--primary-red);
            font-size: 1.5rem;
            margin-bottom: 3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section h4 {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            padding-left: 0.75rem;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar li {
            margin-bottom: 0.5rem;
        }

        .sidebar a {
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--radius);
            transition: var(--transition);
            font-family: var(--font-body);
            gap: 10px;
        }

        .sidebar a:hover,
        .sidebar a.active {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .sidebar a.active {
            border-left: 3px solid var(--primary-red);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            background: transparent;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: var(--bg-glass);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .header h1 {
            margin: 0;
            color: var(--text-primary);
            font-family: var(--font-main);
        }

        .btn-primary {
            background: var(--primary-red);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            transition: var(--transition);
        }

        .btn-primary:hover {
            background: var(--primary-red-light);
        }

        /* Card Grid Layout */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: transform 0.2s;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-red);
        }

        .card-header {
            position: relative;
            height: 200px;
            background: #fff;
            /* White bg for product images */
        }

        .card-header img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 10px;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }

        .status-active {
            background: #28a745;
        }

        .status-inactive {
            background: #dc3545;
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-title {
            font-family: var(--font-main);
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .card-desc {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .card-price {
            color: var(--primary-red);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-delete:hover {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border-color: #dc3545;
        }

        /* New Product Card Design */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }

        .product-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: transform 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-red);
        }

        .card-header {
            position: relative;
            height: 220px;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .card-header img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }

        .status-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #28a745;
        }

        .status-inactive {
            background: #dc3545;
        }

        .card-body {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .card-title {
            font-family: var(--font-main);
            color: var(--text-primary);
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .card-desc {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
            min-height: 2.8em;
        }

        .card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-badge {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .card-price {
            color: var(--primary-red);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .stock-text,
        .date-text {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .card-actions {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 10px;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-weight: 500;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--text-secondary);
        }

        .btn-delete {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
            border-color: #bd2130;
        }
    </style>
</head>

<body class="auto-retro-bg" data-intensity="low">
    <div class="admin-container">
        <div class="sidebar">
            <div class="sidebar-brand">
                <span>‚ö°</span> EIBELSTORE
            </div>

            <div class="sidebar-section">
                <h4>General</h4>
                <ul>
                    <li><a href="../../../products.html">üõçÔ∏è Ver Tienda</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h4>ADMIN</h4>
                <ul>
                    <li><a href="#" class="active">üì¶ Inventario</a></li>
                    <li><a href="#">üìä Manage Statistics</a></li>
                </ul>
            </div>

            <div style="margin-top: auto;">
                <ul>
                    <li><a href="#" onclick="logout()">üö™ Cerrar Sesi√≥n</a></li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>Manage your products</h1>
                <button class="btn-primary" onclick="openModal()">Add Product ‚äï</button>
            </div>

            <div id="productsGrid" class="products-grid">
                <!-- Products will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Nuevo Producto</h2>
            <form id="productForm" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;">
                <input type="hidden" id="productId">

                <div class="form-group">
                    <label>T√≠tulo</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <select id="category" name="category" required>
                        <option value="Anillos">Anillos</option>
                        <option value="Collares">Collares</option>
                        <option value="Relojes">Relojes</option>
                        <option value="Colgantes">Colgantes</option>
                        <option value="Accesorios">Accesorios</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subcategor√≠a</label>
                    <input type="text" id="subcategory" name="subcategory" placeholder="Ej: Plata 925">
                </div>
                <div class="form-group">
                    <label>Precio (Gs.)</label>
                    <input type="number" id="price" name="price" required>
                </div>
                <div class="form-group">
                    <label>Stock</label>
                    <input type="number" id="stock" name="stock" value="1" required>
                </div>

                <!-- Row 2 -->
                <div class="form-group">
                    <label>Badge</label>
                    <input type="text" id="badge" name="badge" placeholder="Ej: NUEVO">
                </div>

                <div class="form-group" style="grid-column: span 4;">
                    <label>Descripci√≥n</label>
                    <textarea id="description" name="description" rows="1" style="height: 42px;"></textarea>
                </div>

                <!-- Row 3 -->
                <div class="form-group" style="grid-column: span 5;">
                    <label>Im√°genes</label>
                    <input type="file" id="images" name="images" multiple accept="image/*">
                    <div id="imagePreviews" style="margin-top: 10px; display: flex; flex-wrap: wrap;"></div>
                </div>

                <div style="grid-column: span 5; text-align: right; margin-top: 10px;">
                    <button type="button" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../js/background.js"></script>
    <script>
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Check auth
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        // Load Products
        async function loadProducts() {
            const grid = document.getElementById('productsGrid');
            try {
                const res = await fetch('http://localhost:3000/api/products');
                if (res.ok) {
                    const products = await res.json();
                    if (products.length === 0) {
                        grid.innerHTML = '<p style="color:white; grid-column: 1/-1; text-align:center;">No hay productos</p>';
                        return;
                    }
                    grid.innerHTML = products.map(p => {
                        const img = p.image_url || p.image || 'https://placehold.co/300x200';
                        const displayImg = img.startsWith('/uploads') ? `http://localhost:3000${img}` : img;
                        const isActive = p.is_active !== false; // Default true

                        return `
                        <div class="product-card">
                            <div class="card-header">
                                <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                                    ${isActive ? 'Active' : 'Inactive'}
                                </span>
                                <img src="${displayImg}" alt="${p.title}">
                            </div>
                            <div class="card-body">
                                <h3 class="card-title">${p.title}</h3>
                                <p class="card-desc">${p.description || 'Sin descripci√≥n'}</p>
                                
                                <div class="card-row">
                                    <span class="category-badge">${p.category || 'GENERAL'}</span>
                                    <div class="card-price">$${Number(p.price).toLocaleString('es-PY')}</div>
                                </div>

                                <div class="card-row">
                                    <span class="stock-text">Stock: ${p.stock || 0}</span>
                                    <span class="date-text">12/10/2025</span>
                                </div>

                                <div class="card-actions">
                                    <button class="action-btn" onclick='openModal(${JSON.stringify(p).replace(/"/g, "&quot;")})'>
                                        Edit üìù
                                    </button>
                                    <button class="action-btn btn-delete" onclick="deleteProduct(${p.id})">
                                        Delete üóëÔ∏è
                                    </button>
                                    <button class="action-btn" onclick="togglePublish(${p.id}, ${isActive})">
                                        ${isActive ? 'Unpublish üö´' : 'Publish ‚úÖ'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `}).join('');
                } else {
                    console.error('API Error:', res.status);
                }
            } catch (e) {
                console.error(e);
            }
        }
        loadProducts();

        // Toggle Publish
        async function togglePublish(id, currentStatus) {
            try {
                // We need to fetch the product first to get all data, or just PATCH if API supported it.
                // Our updateProduct expects all fields. For simplicity, let's fetch, then update.
                // OR, we can just send the is_active flag if we modify the backend to support partial updates.
                // But our backend expects all fields in the PUT body usually.
                // Let's try to fetch first.
                const res = await fetch(`http://localhost:3000/api/products/${id}`);
                const product = await res.json();

                const formData = new URLSearchParams();
                formData.append('title', product.title);
                formData.append('category', product.category);
                formData.append('subcategory', product.subcategory || '');
                formData.append('price', product.price);
                formData.append('stock', product.stock);
                formData.append('description', product.description || '');
                formData.append('badge', product.badge || '');
                formData.append('is_active', !currentStatus);
                // Images are tricky with FormData vs JSON. Our backend handles multipart/form-data.
                // We can't easily re-upload existing images via URLSearchParams.
                // We need to construct a FormData object but we don't have the file objects.
                // The backend logic: if no new file, keep old. So we just don't send 'images'.

                // But wait, our backend uses multer which expects multipart.
                // We can send a PUT request with JSON if we modify backend to accept JSON for updates too?
                // Currently backend uses `upload.array('images')` which parses body.

                // Let's use FormData without files.
                const data = new FormData();
                data.append('title', product.title);
                data.append('category', product.category);
                data.append('subcategory', product.subcategory || '');
                data.append('price', product.price);
                data.append('stock', product.stock);
                data.append('description', product.description || '');
                data.append('badge', product.badge || '');
                data.append('is_active', !currentStatus);

                const updateRes = await fetch(`http://localhost:3000/api/products/${id}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: data
                });

                if (updateRes.ok) {
                    loadProducts();
                } else {
                    alert('Error updating status');
                }
            } catch (e) {
                console.error(e);
                alert('Error de conexi√≥n');
            }
        }

        // Modal Logic
        let selectedFiles = [];
        const modal = document.getElementById('productModal');
        const form = document.getElementById('productForm');

        function openModal(product = null) {
            selectedFiles = [];
            updateImagePreviews();

            if (product) {
                document.getElementById('modalTitle').textContent = 'Editar Producto';
                document.getElementById('productId').value = product.id;
                document.getElementById('title').value = product.title;
                document.getElementById('category').value = product.category;
                document.getElementById('subcategory').value = product.subcategory || '';
                document.getElementById('price').value = product.price;
                document.getElementById('stock').value = product.stock || 0;
                document.getElementById('badge').value = product.badge || '';
                document.getElementById('description').value = product.description || '';
            } else {
                document.getElementById('modalTitle').textContent = 'Nuevo Producto';
                form.reset();
                document.getElementById('productId').value = '';
            }
            modal.style.display = 'flex';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        // File Input
        const fileInput = document.getElementById('images');
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            selectedFiles = [...selectedFiles, ...files];
            updateImagePreviews();
            fileInput.value = '';
        });

        function updateImagePreviews() {
            const container = document.getElementById('imagePreviews');
            container.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'position: relative; display: inline-block; margin: 5px;';

                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #555;';

                const btn = document.createElement('button');
                btn.innerHTML = '√ó';
                btn.style.cssText = 'position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1;';
                btn.type = 'button';
                btn.onclick = () => {
                    selectedFiles.splice(index, 1);
                    updateImagePreviews();
                };

                div.appendChild(img);
                div.appendChild(btn);
                container.appendChild(div);
            });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const formData = new FormData(e.target);
            if (!id) formData.delete('id');

            formData.delete('images');
            selectedFiles.forEach(file => formData.append('images', file));

            const method = id ? 'PUT' : 'POST';
            const url = id ? `http://localhost:3000/api/products/${id}` : 'http://localhost:3000/api/products';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                if (res.ok) {
                    closeModal();
                    loadProducts();
                } else {
                    alert('Error al guardar');
                }
            } catch (e) {
                console.error(e);
                alert('Error de conexi√≥n');
            }
        });

        async function deleteProduct(id) {
            if (!confirm('¬øEliminar?')) return;
            try {
                const res = await fetch(`http://localhost:3000/api/products/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) loadProducts();
                else alert('Error al eliminar');
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>

</html>